name: Deploy Swagger UI to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths: [ 'openapi.yml', 'openapi.yaml', 'swagger.yml', 'swagger.yaml' ]
  workflow_dispatch:

# GitHub Pages ë°°í¬ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pages: write
  id-token: write

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ë¹Œë“œì™€ ë°°í¬ë¥¼ ë¶„ë¦¬ (ê¶Œì¥ íŒ¨í„´)
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find OpenAPI specification file
      id: find-spec
      run: |
        # ê°€ëŠ¥í•œ OpenAPI íŒŒì¼ëª…ë“¤ í™•ì¸
        if [ -f "openapi.yml" ]; then
          echo "spec_file=openapi.yml" >> $GITHUB_OUTPUT
        elif [ -f "openapi.yaml" ]; then
          echo "spec_file=openapi.yaml" >> $GITHUB_OUTPUT
        elif [ -f "swagger.yml" ]; then
          echo "spec_file=swagger.yml" >> $GITHUB_OUTPUT
        elif [ -f "swagger.yaml" ]; then
          echo "spec_file=swagger.yaml" >> $GITHUB_OUTPUT
        else
          echo "âŒ OpenAPI specification file not found!"
          echo "Looking for: openapi.yml, openapi.yaml, swagger.yml, swagger.yaml"
          ls -la
          exit 1
        fi
        echo "âœ… Found: ${{ steps.find-spec.outputs.spec_file }}"

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Create Swagger UI directory
      run: mkdir -p swagger-ui

    # CDN ë°©ì‹ - ë” ì•ˆì •ì ì´ê³  ë¹ ë¦„
    - name: Generate Swagger UI with CDN
      run: |
        cat > swagger-ui/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>API Documentation</title>
            <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui.css" />
            <link rel="icon" type="image/png" href="https://unpkg.com/swagger-ui-dist@5.21.0/favicon-32x32.png" sizes="32x32" />
            <link rel="icon" type="image/png" href="https://unpkg.com/swagger-ui-dist@5.21.0/favicon-16x16.png" sizes="16x16" />
            <style>
                html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
                *, *:before, *:after { box-sizing: inherit; }
                body { margin:0; background: #fafafa; }
            </style>
        </head>
        <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-standalone-preset.js"></script>
            <script>
                window.onload = function() {
                    // API ìŠ¤í™ íŒŒì¼ ê²½ë¡œ ì„¤ì •
                    const ui = SwaggerUIBundle({
                        url: './SPEC_FILE_PLACEHOLDER',
                        dom_id: '#swagger-ui',
                        deepLinking: true,
                        presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                        ],
                        plugins: [
                            SwaggerUIBundle.plugins.DownloadUrl
                        ],
                        layout: "StandaloneLayout",
                        tryItOutEnabled: true,
                        supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch', 'head', 'options'],
                        onComplete: function() {
                            console.log("âœ… Swagger UI loaded successfully");
                        },
                        onFailure: function(data) {
                            console.error("âŒ Failed to load API spec:", data);
                        }
                    });
                    window.ui = ui;
                };
            </script>
        </body>
        </html>
        EOF
        
        # í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ íŒŒì¼ëª…ìœ¼ë¡œ êµì²´
        sed -i "s/SPEC_FILE_PLACEHOLDER/${{ steps.find-spec.outputs.spec_file }}/g" swagger-ui/index.html
        
        # OpenAPI ìŠ¤í™ íŒŒì¼ ë³µì‚¬
        cp "${{ steps.find-spec.outputs.spec_file }}" swagger-ui/
        
        echo "âœ… Swagger UI generated successfully"
        echo "ğŸ“ Generated files:"
        ls -la swagger-ui/

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './swagger-ui'

  # ë³„ë„ì˜ ë°°í¬ job
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    # GitHub Pages í™˜ê²½ ì„¤ì •
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4