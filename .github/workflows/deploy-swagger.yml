name: Deploy Swagger UI to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths: [ 'openapi.yml', 'openapi.yaml', 'swagger.yml', 'swagger.yaml' ]
  workflow_dispatch:

# GitHub Pages Î∞∞Ìè¨Ïóê ÌïÑÏöîÌïú Í∂åÌïú ÏÑ§Ï†ï
permissions:
  contents: read
  pages: write
  id-token: write

# ÎèôÏãú Î∞∞Ìè¨ Î∞©ÏßÄ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ÎπåÎìúÏôÄ Î∞∞Ìè¨Î•º Î∂ÑÎ¶¨ (Í∂åÏû• Ìå®ÌÑ¥)
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find OpenAPI specification file
      id: find-spec
      run: |
        echo "üîç Searching for OpenAPI specification files..."
        echo "üìÅ Current directory contents:"
        ls -la
        
        echo ""
        echo "üîé Checking for specific files:"
        
        # Í∞Å ÌååÏùº Ï°¥Ïû¨ Ïó¨Î∂ÄÎ•º Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú ÌôïÏù∏
        for file in "openapi.yml" "openapi.yaml" "swagger.yml" "swagger.yaml"; do
          if [ -f "$file" ]; then
            echo "‚úÖ Found: $file"
          else
            echo "‚ùå Not found: $file"
          fi
        done
        
        echo ""
        
        # OpenAPI ÌååÏùº Ï∞æÍ∏∞
        SPEC_FILE=""
        if [ -f "openapi.yml" ]; then
          SPEC_FILE="openapi.yml"
        elif [ -f "openapi.yaml" ]; then
          SPEC_FILE="openapi.yaml"
        elif [ -f "swagger.yml" ]; then
          SPEC_FILE="swagger.yml"
        elif [ -f "swagger.yaml" ]; then
          SPEC_FILE="swagger.yaml"
        fi
        
        if [ -z "$SPEC_FILE" ]; then
          echo "‚ùå OpenAPI specification file not found!"
          echo "üìã Looking for: openapi.yml, openapi.yaml, swagger.yml, swagger.yaml"
          echo "üìÅ Available files:"
          find . -name "*.yml" -o -name "*.yaml" -o -name "*.json" | head -10
          exit 1
        fi
        
        echo "spec_file=$SPEC_FILE" >> $GITHUB_OUTPUT
        echo "‚úÖ Found OpenAPI file: $SPEC_FILE"

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Create Swagger UI directory
      run: mkdir -p swagger-ui

    # CDN Î∞©Ïãù - Îçî ÏïàÏ†ïÏ†ÅÏù¥Í≥† Îπ†Î¶Ñ
    - name: Validate OpenAPI file
      run: |
        SPEC_FILE="${{ steps.find-spec.outputs.spec_file }}"
        echo "üîç Validating OpenAPI file: $SPEC_FILE"
        
        # ÌååÏùº Ï°¥Ïû¨ Ïû¨ÌôïÏù∏
        if [ ! -f "$SPEC_FILE" ]; then
          echo "‚ùå OpenAPI file not found: $SPEC_FILE"
          echo "üìÅ Current directory:"
          ls -la
          exit 1
        fi
        
        # ÌååÏùº Ï†ïÎ≥¥ Ï∂úÎ†•
        echo "üìÑ File info:"
        ls -lh "$SPEC_FILE"
        
        # ÌååÏùº ÎÇ¥Ïö© ÎØ∏Î¶¨Î≥¥Í∏∞
        echo "üìÑ File content preview (first 20 lines):"
        head -20 "$SPEC_FILE"
        
        # YAML Î¨∏Î≤ï Í≤ÄÏ¶ù
        echo "üîç Validating YAML syntax..."
        python3 -c "
        import yaml
        import sys
        try:
            with open('$SPEC_FILE', 'r', encoding='utf-8') as f:
                data = yaml.safe_load(f)
            print('‚úÖ YAML syntax is valid')
            
            # OpenAPI Í∏∞Î≥∏ Íµ¨Ï°∞ ÌôïÏù∏
            if 'openapi' in data:
                print(f'‚úÖ OpenAPI version: {data[\"openapi\"]}')
            elif 'swagger' in data:
                print(f'‚úÖ Swagger version: {data[\"swagger\"]}')
            else:
                print('‚ö†Ô∏è No openapi or swagger version found')
                
            if 'info' in data and 'title' in data['info']:
                print(f'‚úÖ API title: {data[\"info\"][\"title\"]}')
            else:
                print('‚ö†Ô∏è No API title found in info section')
                
        except Exception as e:
            print(f'‚ùå YAML/OpenAPI validation error: {e}')
            sys.exit(1)
        "

    - name: Generate Swagger UI with enhanced error handling
      run: |
        SPEC_FILE="${{ steps.find-spec.outputs.spec_file }}"
        echo "üöÄ Generating Swagger UI for: $SPEC_FILE"
        
        cat > swagger-ui/index.html << EOF
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>API Documentation</title>
            <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui.css" />
            <link rel="icon" type="image/png" href="https://unpkg.com/swagger-ui-dist@5.21.0/favicon-32x32.png" sizes="32x32" />
            <style>
                html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
                *, *:before, *:after { box-sizing: inherit; }
                body { margin:0; background: #fafafa; }
                .loading { text-align: center; padding: 50px; font-family: Arial, sans-serif; }
                .error { color: red; background: #fee; padding: 10px; margin: 10px; border: 1px solid red; }
                .info { background: #d1ecf1; color: #0c5460; padding: 10px; margin: 10px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <div class="info">
                <strong>üìÑ Loading API Specification:</strong> ${SPEC_FILE}
            </div>
            <div id="loading" class="loading">
                <h2>üîÑ Loading API Documentation...</h2>
                <p>Spec file: <strong>${SPEC_FILE}</strong></p>
            </div>
            <div id="swagger-ui"></div>
            
            <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-standalone-preset.js"></script>
            <script>
                window.onload = function() {
                    console.log('üöÄ Starting Swagger UI...');
                    console.log('üìÅ Looking for spec file: ${SPEC_FILE}');
                    
                    // Î°úÎî© ÌëúÏãú Ïà®Í∏∞Í∏∞
                    setTimeout(() => {
                        const loading = document.getElementById('loading');
                        if (loading) loading.style.display = 'none';
                    }, 2000);
                    
                    const ui = SwaggerUIBundle({
                        url: './${SPEC_FILE}',
                        dom_id: '#swagger-ui',
                        deepLinking: true,
                        presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                        ],
                        plugins: [
                            SwaggerUIBundle.plugins.DownloadUrl
                        ],
                        layout: "StandaloneLayout",
                        tryItOutEnabled: true,
                        supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch', 'head', 'options'],
                        onComplete: function() {
                            console.log('‚úÖ Swagger UI loaded successfully');
                            console.log('üìä API spec loaded from: ${SPEC_FILE}');
                            document.getElementById('loading').style.display = 'none';
                        },
                        onFailure: function(data) {
                            console.error('‚ùå Failed to load API spec:', data);
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('swagger-ui').innerHTML = 
                                '<div class="error">' +
                                '<h3>‚ùå Failed to load API specification</h3>' +
                                '<p><strong>File:</strong> ${SPEC_FILE}</p>' +
                                '<p><strong>Error:</strong> ' + JSON.stringify(data) + '</p>' +
                                '<p>Please check the browser console for more details.</p>' +
                                '<p>Try accessing the file directly: <a href="./${SPEC_FILE}" target="_blank">${SPEC_FILE}</a></p>' +
                                '</div>';
                        }
                    });
                    
                    window.ui = ui;
                    
                    // ÌååÏùº Ï°¥Ïû¨ ÌôïÏù∏
                    fetch('./${SPEC_FILE}')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }
                            console.log('‚úÖ OpenAPI file accessible via HTTP');
                            console.log('üìè Response status:', response.status);
                            console.log('üìÑ Content-Type:', response.headers.get('content-type'));
                            return response.text();
                        })
                        .then(content => {
                            console.log('üìÑ OpenAPI file content length:', content.length);
                            console.log('üìÑ First 200 chars:', content.substring(0, 200));
                        })
                        .catch(error => {
                            console.error('‚ùå Cannot fetch OpenAPI file:', error);
                            document.getElementById('swagger-ui').innerHTML = 
                                '<div class="error">' +
                                '<h3>‚ùå Cannot access OpenAPI file</h3>' +
                                '<p><strong>File:</strong> ${SPEC_FILE}</p>' +
                                '<p><strong>Error:</strong> ' + error.message + '</p>' +
                                '<p>Make sure the file exists and is accessible.</p>' +
                                '</div>';
                        });
                };
            </script>
        </body>
        </html>
        EOF
        
        # OpenAPI Ïä§Ìéô ÌååÏùº Î≥µÏÇ¨
        echo "üìÅ Copying spec file..."
        cp "$SPEC_FILE" swagger-ui/
        
        echo "‚úÖ Swagger UI generated with spec file: $SPEC_FILE"
        echo "üìÅ Generated files:"
        ls -la swagger-ui/
        
        echo "üìÑ Verifying copied spec file:"
        ls -la "swagger-ui/$SPEC_FILE"
        
        # Î≥µÏÇ¨Îêú ÌååÏùº ÎÇ¥Ïö© ÌôïÏù∏
        echo "üìÑ First few lines of copied file:"
        head -5 "swagger-ui/$SPEC_FILE"

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './swagger-ui'

  # Î≥ÑÎèÑÏùò Î∞∞Ìè¨ job
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    # GitHub Pages ÌôòÍ≤Ω ÏÑ§Ï†ï
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4