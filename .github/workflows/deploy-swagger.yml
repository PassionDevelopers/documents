name: Deploy Multi-Environment Swagger UI to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths: [ 'openapi*.yml', 'openapi*.yaml', 'swagger*.yml', 'swagger*.yaml' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Find OpenAPI specification files
      id: find-specs
      run: |
        echo "ğŸ” Searching for OpenAPI specification files..."
        
        DEV_FILE=""
        PROD_FILE=""
        
        for file in "openapi-dev.yml" "openapi-dev.yaml"; do
          if [ -f "$file" ]; then
            DEV_FILE="$file"
            echo "âœ… Found dev file: $file"
            break
          fi
        done
        
        for file in "openapi-prod.yml" "openapi-prod.yaml"; do
          if [ -f "$file" ]; then
            PROD_FILE="$file"
            echo "âœ… Found prod file: $file"
            break
          fi
        done
        
        echo "dev_file=$DEV_FILE" >> $GITHUB_OUTPUT
        echo "prod_file=$PROD_FILE" >> $GITHUB_OUTPUT
        
        if [ -z "$DEV_FILE" ] && [ -z "$PROD_FILE" ]; then
          echo "âŒ No OpenAPI specification files found!"
          exit 1
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v5

    - name: Create directory structure
      run: |
        mkdir -p swagger-ui/dev
        mkdir -p swagger-ui/prod

    - name: Generate Development Environment
      if: steps.find-specs.outputs.dev_file != ''
      run: |
        DEV_FILE="${{ steps.find-specs.outputs.dev_file }}"
        SPEC_FILENAME=$(basename "$DEV_FILE")
        
        # Create dev Swagger UI
        cat > swagger-ui/dev/index.html << 'EOF'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤ì‹œ ìŠ¤íƒ ë“œ API Documentation - Development</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui.css" />
    <style>
        .header { background: #1f2937; color: white; padding: 1rem; text-align: center; }
        .env-badge { background: #059669; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; }
        .nav-links { text-align: center; padding: 1rem; background: #f9fafb; }
        .nav-links a { margin: 0 1rem; padding: 0.5rem 1rem; text-decoration: none; color: #374151; }
        .nav-links a.active { background: #3b82f6; color: white; border-radius: 0.375rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ë‹¤ì‹œ ìŠ¤íƒ ë“œ API Documentation</h1>
        <span class="env-badge">Development</span>
    </div>
    <div class="nav-links">
        <a href="../">í™ˆ</a>
        <a href="../dev/" class="active">ê°œë°œ í™˜ê²½</a>
        <a href="../prod/">í”„ë¡œë•ì…˜ í™˜ê²½</a>
    </div>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-standalone-preset.js"></script>
    <script>
        SwaggerUIBundle({
            url: './SPEC_FILE_PLACEHOLDER',
            dom_id: '#swagger-ui',
            deepLinking: true,
            presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
            layout: "StandaloneLayout"
        });
    </script>
</body>
</html>
EOF
        
        sed -i "s/SPEC_FILE_PLACEHOLDER/$SPEC_FILENAME/g" swagger-ui/dev/index.html
        cp "$DEV_FILE" "swagger-ui/dev/$SPEC_FILENAME"
        echo "âœ… Development environment generated"

    - name: Generate Production Environment
      if: steps.find-specs.outputs.prod_file != ''
      run: |
        PROD_FILE="${{ steps.find-specs.outputs.prod_file }}"
        SPEC_FILENAME=$(basename "$PROD_FILE")
        
        # Create prod Swagger UI
        cat > swagger-ui/prod/index.html << 'EOF'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤ì‹œ ìŠ¤íƒ ë“œ API Documentation - Production</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui.css" />
    <style>
        .header { background: #1f2937; color: white; padding: 1rem; text-align: center; }
        .env-badge { background: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 0.375rem; }
        .nav-links { text-align: center; padding: 1rem; background: #f9fafb; }
        .nav-links a { margin: 0 1rem; padding: 0.5rem 1rem; text-decoration: none; color: #374151; }
        .nav-links a.active { background: #3b82f6; color: white; border-radius: 0.375rem; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ë‹¤ì‹œ ìŠ¤íƒ ë“œ API Documentation</h1>
        <span class="env-badge">Production</span>
    </div>
    <div class="nav-links">
        <a href="../">í™ˆ</a>
        <a href="../dev/">ê°œë°œ í™˜ê²½</a>
        <a href="../prod/" class="active">í”„ë¡œë•ì…˜ í™˜ê²½</a>
    </div>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.21.0/swagger-ui-standalone-preset.js"></script>
    <script>
        SwaggerUIBundle({
            url: './SPEC_FILE_PLACEHOLDER',
            dom_id: '#swagger-ui',
            deepLinking: true,
            presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
            layout: "StandaloneLayout"
        });
    </script>
</body>
</html>
EOF
        
        sed -i "s/SPEC_FILE_PLACEHOLDER/$SPEC_FILENAME/g" swagger-ui/prod/index.html
        cp "$PROD_FILE" "swagger-ui/prod/$SPEC_FILENAME"
        echo "âœ… Production environment generated"

    - name: Generate Main Index Page
      run: |
        DEV_FILE="${{ steps.find-specs.outputs.dev_file }}"
        PROD_FILE="${{ steps.find-specs.outputs.prod_file }}"
        
        # Create main index page
        cat > swagger-ui/index.html << 'EOF'
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤ì‹œ ìŠ¤íƒ ë“œ API Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }
        h1 { color: #2d3748; font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { color: #718096; font-size: 1.1rem; margin-bottom: 2rem; }
        .environments { display: grid; gap: 1rem; margin-top: 2rem; }
        .env-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            display: block;
        }
        .env-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .env-card.dev { border-color: #38a169; }
        .env-card.dev:hover { border-color: #2f855a; background: #f0fff4; }
        .env-card.prod { border-color: #e53e3e; }
        .env-card.prod:hover { border-color: #c53030; background: #fff5f5; }
        .env-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .env-description { color: #718096; margin-bottom: 1rem; }
        .env-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .badge-dev { background: #c6f6d5; color: #22543d; }
        .badge-prod { background: #fed7d7; color: #742a2a; }
        .footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 0.875rem;
        }
        .unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f7fafc;
        }
        .unavailable:hover { transform: none; box-shadow: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë‹¤ì‹œ ìŠ¤íƒ ë“œ</h1>
        <p class="subtitle">ë‹¤ì–‘í•œ ê´€ì ì˜ ì •ì¹˜ ë‰´ìŠ¤ API Documentation</p>
        <div class="environments">
            DEV_CARD_PLACEHOLDER
            PROD_CARD_PLACEHOLDER
        </div>
        <div class="footer">
            <p>ğŸ”§ ê°œë°œ í™˜ê²½ê³¼ ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ ì¤‘ ì›í•˜ëŠ” API ë¬¸ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            <p><small>Powered by Swagger UI | íŒ¨ì…˜ê°œë°œìë“¤</small></p>
        </div>
    </div>
</body>
</html>
EOF
        
        # Generate environment cards using heredoc to avoid quote issues
        if [ -n "$DEV_FILE" ]; then
          cat > /tmp/dev_card.html << 'CARD_EOF'
<a href="./dev/" class="env-card dev">
  <div class="env-title">ğŸ”§ ê°œë°œ í™˜ê²½</div>
  <div class="env-description">ê°œë°œ ë° í…ŒìŠ¤íŠ¸ìš© API ìŠ¤í™</div>
  <span class="env-badge badge-dev">Development</span>
</a>
CARD_EOF
        else
          cat > /tmp/dev_card.html << 'CARD_EOF'
<div class="env-card unavailable">
  <div class="env-title">ğŸ”§ ê°œë°œ í™˜ê²½</div>
  <div class="env-description">ê°œë°œ í™˜ê²½ API ìŠ¤í™ì´ ì—†ìŠµë‹ˆë‹¤</div>
  <span class="env-badge badge-dev">Unavailable</span>
</div>
CARD_EOF
        fi
        
        if [ -n "$PROD_FILE" ]; then
          cat > /tmp/prod_card.html << 'CARD_EOF'
<a href="./prod/" class="env-card prod">
  <div class="env-title">ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½</div>
  <div class="env-description">ì‹¤ì œ ì„œë¹„ìŠ¤ìš© API ìŠ¤í™</div>
  <span class="env-badge badge-prod">Production</span>
</a>
CARD_EOF
        else
          cat > /tmp/prod_card.html << 'CARD_EOF'
<div class="env-card unavailable">
  <div class="env-title">ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½</div>
  <div class="env-description">í”„ë¡œë•ì…˜ í™˜ê²½ API ìŠ¤í™ì´ ì—†ìŠµë‹ˆë‹¤</div>
  <span class="env-badge badge-prod">Unavailable</span>
</div>
CARD_EOF
        fi
        
        # Replace placeholders with file contents
        sed -i '/DEV_CARD_PLACEHOLDER/r /tmp/dev_card.html' swagger-ui/index.html
        sed -i '/DEV_CARD_PLACEHOLDER/d' swagger-ui/index.html
        sed -i '/PROD_CARD_PLACEHOLDER/r /tmp/prod_card.html' swagger-ui/index.html
        sed -i '/PROD_CARD_PLACEHOLDER/d' swagger-ui/index.html
        
        # Clean up temporary files
        rm -f /tmp/dev_card.html /tmp/prod_card.html
        echo "âœ… Main index page generated"

    - name: Verify generated files
      run: |
        echo "ğŸ“ Generated files:"
        find swagger-ui -type f | sort
        echo ""
        echo "ğŸ“„ File sizes:"
        find swagger-ui -type f -exec ls -lh {} \;

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './swagger-ui'

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4